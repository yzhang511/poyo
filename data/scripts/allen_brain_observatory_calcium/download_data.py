from allensdk.core.brain_observatory_cache import BrainObservatoryCache
import os
import numpy as np
import pandas as pd
import argparse
import shutil

if __name__ == "__main__":
    SESSION_IDS = [
        "649409874",
        "604328043",
        "556353209",
        "627823695",
        "662982346",
        "645689073",
        "657776356",
        "613091721",
        "652094901",
        "560809202",
        "545446482",
        "502793808",
        "581597734",
        "594320795",
        "501940850",
        "546641574",
        "638862121",
        "614556106",
        "595273803",
        "601705404",
        "662361096",
        "511194579",
        "603763073",
        "645086975",
        "662359728",
        "504853580",
        "657078119",
        "581150104",
        "644026238",
        "698762886",
        "660510593",
        "607063420",
        "652091264",
        "688580172",
        "601273921",
        "613968705",
        "651770186",
        "647155122",
        "639117196",
        "652737678",
        "603452291",
        "639117826",
        "657082055",
        "652842495",
        "692345003",
        "556344224",
        "575135986",
        "715923832",
        "505407318",
        "645413759",
        "638056634",
        "657785850",
        "710504563",
        "570305847",
        "627823636",
        "665307545",
        "566307038",
        "598635821",
        "657016267",
        "612543999",
        "502199136",
        "502666254",
        "540684467",
        "502205092",
        "680156911",
        "591460070",
        "638262558",
        "662358771",
        "562052595",
        "572722662",
        "623347352",
        "539487468",
        "604145810",
        "661437140",
        "662348804",
        "606802468",
        "670395725",
        "612044635",
        "710778377",
        "552760671",
        "601887677",
        "552427971",
        "571642389",
        "565698388",
        "657391625",
        "688678766",
        "510517131",
        "506823562",
        "569299884",
        "553568031",
        "583279803",
        "580163817",
        "663876406",
        "501021421",
        "595718342",
        "653125130",
        "716956096",
        "611658482",
        "674276329",
        "652842572",
        "689388034",
        "511440894",
        "557848210",
        "558670888",
        "539497234",
        "674275260",
        "616779893",
        "569396924",
        "588191926",
        "582918858",
        "612549085",
        "503412730",
        "601910964",
        "637669284",
        "606353987",
        "643062797",
        "511534603",
        "672211004",
        "539290504",
        "702934964",
        "560898462",
        "573083539",
        "603187982",
        "530645663",
        "526504941",
        "561312435",
        "664404274",
        "562711440",
        "577379202",
        "710502981",
        "569792817",
        "580043440",
        "662351164",
        "573720508",
        "599909878",
        "674679019",
        "603188560",
        "560920977",
        "645256361",
        "508753256",
        "673475020",
        "547388708",
        "669233895",
        "575939366",
        "701046700",
        "657224241",
        "573850303",
        "593373156",
        "569457162",
        "657009581",
        "512164988",
        "571541565",
        "504115289",
        "504568756",
        "580013262",
        "502962794",
        "657390171",
        "512326618",
        "576273468",
        "512270518",
        "587344053",
        "569896493",
        "671618887",
        "652096183",
        "696156783",
        "501933264",
        "712178483",
        "580051759",
        "691197571",
        "575970700",
        "670721589",
        "647143225",
        "707006626",
        "602866800",
        "643645390",
        "663485329",
        "647598519",
        "505845219",
        "601805379",
        "659491419",
        "707923645",
        "529688779",
        "502115959",
        "653126877",
        "548379748",
        "686442556",
        "651769499",
        "601423209",
        "589755795",
        "612534310",
        "528402271",
        "692345336",
        "558476282",
        "601841437",
        "562536153",
        "601368107",
        "639932847",
        "555040116",
        "589441079",
        "665726618",
        "669237515",
        "596509886",
        "554037270",
        "507129766",
        "550455111",
        "686449092",
        "593552712",
        "649401936",
        "585035184",
        "506540916",
        "637126541",
        "546716391",
        "510214538",
        "662033243",
        "502608215",
        "560578599",
        "686441799",
        "614571626",
        "704298735",
        "605859367",
        "605688822",
        "663479824",
        "647603932",
        "527048992",
        "597028938",
        "605883133",
        "569718097",
        "626027944",
        "581153070",
        "510917254",
        "657915168",
        "644947716",
        "556665481",
        "560926639",
        "509580400",
        "571177441",
        "712919665",
        "653932505",
        "653551965",
        "574823092",
        "662219852",
        "592407200",
        "643592303",
        "592657427",
        "503109347",
        "560027980",
        "609894681",
        "647595671",
        "511595995",
        "654532828",
        "657914280",
        "670728674",
        "664914611",
        "644051974",
        "652737867",
        "557615965",
        "703308071",
        "652094917",
        "642278925",
        "566458505",
        "596584192",
        "580095647",
        "531134090",
        "639251932",
        "612536911",
        "564607188",
        "550851591",
        "669861524",
        "675477919",
        "506773892",
        "679700458",
        "550490398",
        "613599811",
        "590168385",
        "571137446",
        "637671554",
        "557304694",
        "595263154",
        "652092676",
        "552410386",
        "593270603",
        "657389972",
        "584196534",
        "660513003",
        "563176332",
        "603576132",
        "594090967",
        "510859641",
        "569645690",
        "595183197",
        "578674360",
        "623339221",
        "584944065",
        "642884591",
        "657391037",
        "506809539",
        "509904120",
        "640198011",
        "556321897",
        "651770794",
        "663866413",
        "555749369",
        "671164733",
        "646016204",
        "595808594",
        "644386884",
        "658518486",
        "661328410",
        "667004159",
        "651770380",
        "598137246",
        "596779487",
        "676503588",
        "647595665",
        "559382012",
        "603425659",
        "672206735",
        "512311673",
        "657650110",
        "501729039",
        "639931541",
        "590047029",
        "604529230",
        "669859475",
        "570278597",
        "650079244",
        "658020691",
        "658533763",
        "557227804",
        "592348507",
        "562122508",
        "557225279",
        "585900296",
        "582838758",
        "587339481",
        "576411246",
        "572606382",
        "577665023",
        "699155265",
        "637998955",
        "591548033",
        "653122667",
        "598564173",
        "623587006",
        "603592541",
        "683253712",
        "581026088",
        "566096665",
        "582867147",
        "584983136",
        "682051855",
        "609517556",
        "611638995",
        "508563988",
        "560866155",
        "580095655",
        "660064796",
        "509958730",
        "670395999",
        "563710064",
        "658854537",
        "588655112",
        "599320182",
        "637669270",
        "511573879",
        "551834174",
        "679702884",
        "603978471",
        "665722301",
        "680150733",
        "541290571",
        "541010698",
        "507691036",
        "603224878",
        "637154333",
        "683257169",
        "501876401",
        "595806300",
        "617395455",
        "503324629",
        "570236381",
        "698260532",
        "555042467",
        "508356957",
        "571684733",
        "561472633",
        "576095926",
        "510514474",
        "686909240",
        "591430494",
        "712178511",
        "501574836",
        "584544569",
        "657080632",
        "649938038",
        "569739027",
        "672207947",
        "673914981",
        "601904502",
        "617388117",
        "559192380",
        "505695962",
        "605606109",
        "576001843",
        "524691284",
        "510093797",
        "617381605",
        "507990552",
        "501929610",
        "573261515",
        "682049099",
        "605800963",
        "673171528",
        "652989442",
        "662974315",
        "583136567",
        "502376461",
        "567878987",
        "506773185",
        "575302108",
        "685816006",
        "570008444",
        "571006300",
        "551888519",
        "588483711",
        "676024666",
        "565216523",
        "649324898",
        "564425777",
        "510390912",
        "653123929",
        "657775947",
        "637115675",
    ]

    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--output_dir", type=str, default="./raw", help="Output directory"
    )
    # parser.add_argument("--session_ids", type=int, default=None)
    # parser.add_argument("--session_id", type=str, default=None)
    args = parser.parse_args()

    manifest_path = os.path.join(args.output_dir, "manifest.json")
    boc = BrainObservatoryCache(manifest_file=manifest_path)

    # session_ids = args.session_ids.split(',')
    # curr_sess_id = int(args.session_id)

    for curr_sess_id in SESSION_IDS:
        truncated_file = True
        file_path = os.path.join(
            args.output_dir, f"ophys_experiment_data/{curr_sess_id}.nwb"
        )

        while truncated_file:
            try:
                exp = boc.get_ophys_experiment_data(
                    file_name=file_path, ophys_experiment_id=int(curr_sess_id)
                )
                truncated_file = False
            except OSError:
                os.remove(
                    os.path.join(
                        args.output_dir, f"ophys_experiment_data/{curr_sess_id}.nwb"
                    )
                )
                print(" Truncated file, re-downloading")
