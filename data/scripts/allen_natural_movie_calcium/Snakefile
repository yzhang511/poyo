######################################################
# Allen Brain Observatory Dataset
######################################################

DATASET = "allen_natural_movie_calcium"

RAW_DIR = config["RAW_DIR"]
PROCESSED_DIR = config["PROCESSED_DIR"]
COMPRESSED_DIR = config["COMPRESSED_DIR"]
UNCOMPRESSED_DIR = config["UNCOMPRESSED_DIR"]

SESSION_IDS_NM=['497060401', '500855614', '500860585', '500964514', '501021421', '501271265',
       '501337989', '501474098', '501498760', '501559087', '501567237', '501574836',
       '501704220', '501717543', '501729039', '501773889', '501788003', '501794235',
       '501836392', '501886692', '502115959', '502205092', '502368172', '502608215',
       '502634578', '502665019', '502741583', '502810282', '502962794', '502974807',
       '503019786', '503109347', '504642019', '506353473', '508220632', '508356957',
       '508546728', '508596945', '508753256', '509644421', '509729072', '509962140',
       '510174759', '510214538', '510345479', '510514474', '510517131', '510705057',
       '511242327', '511434920', '511534603', '512124564', '512176430', '512270518',
       '524691284', '524848692', '525368285', '526504941', '526768996', '526928092',
       '527048992', '527583578', '528402271', '528480613', '528574532', '528693630',
       '528792732', '528972913', '529693740', '529763302', '530181996', '530318805',
       '530645663', '530739576', '530773844', '531008833', '531124922', '531134090',
       '531342486', '531348161', '537153918', '538803517', '539000397', '539290504',
       '539291372', '539487468', '539497234', '539515366', '539540432', '539643002',
       '540168837', '540609585', '540684467', '540729056', '540993890', '541010698',
       '541048140', '541206592', '541290571', '543677427', '544507627', '545446482',
       '545578997', '546341286', '546716391', '547388708', '547573479', '549483412',
       '558581038', '559082739', '559192380', '561312435', '561994407', '562095852',
       '570278597', '570472763', '570888896', '571137446', '571177752', '571494829',
       '586351981', '587071892', '587344053', '590168385', '590565013', '591300156',
       '591414748', '591537010', '592407200', '592655327', '593240301', '593373156',
       '595263154', '595452192', '595719414', '595806300', '596525298', '596584192',
       '596769570', '596824582', '597014165', '598564173', '599586915', '601260046',
       '602857315', '603224878', '603905059', '617381605', '617429820', '623338499',
       '623339891', '623347352', '636930038', '637115675', '637669270', '637671554',
       '637672042', '637994504', '637998955', '638262098', '638262535', '638754323',
       '638754561', '639254728', '639437387', '642651898', '642883713', '643592303',
       '643645390', '644026238', '644660705', '644909644', '644910997', '644949350',
       '645413759', '645691416', '646959487', '647155122', '648186871', '648377368',
       '648389302', '648644110', '649401936', '649938038', '650389887', '650512363',
       '652094901', '652340572', '652842572', '652988777', '653053207', '653054766',
       '653122667', '653125130', '653173685', '653331120', '653552163', '653923501',
       '653932505', '654920038', '656381309', '656939127', '657012597', '657016267',
       '657080632', '657082055', '657087057', '657469734', '657649672', '657892406',
       '658536111', '658816715', '658854887', '659491419', '659743451', '659746625',
       '659767482', '659771301', '660065134', '660066712', '660513003', '661328410',
       '661437140', '661744804', '661753184', '662033243', '662107986', '662351346',
       '662358233', '662974315', '662989044', '663479950', '663485329', '663868345',
       '663873076', '664404274', '666589601', '667011230', '667364442', '667376208',
       '674679019', '675067662', '675478137', '679702884', '680156911', '680601319',
       '681673022', '681674286', '682054669', '682734792', '683257169', '685494041',
       '688678766', '690045763', '691763694', '702934964', '703308147', '703731696',
       '704298735', '704826374', '705412356', '712178511', '712924011', '714778358']

rule all:
    input:
        f"{PROCESSED_DIR}/{DATASET}/description.mpk"

#rule download_one:
#    output:
#        nwb_file = f"{RAW_DIR}/{DATASET}/ophys_experiment_data/{{dataset}}.nwb"
#    shell:
#        f"""
#        mkdir -p {RAW_DIR}/{DATASET}
#        python data/scripts/{DATASET}/download_data.py --output_dir {RAW_DIR}/{DATASET} --session_id {{wildcards.session_id}}
#        """

#rule download_all:
#    input:
#       nwb_files = expand(f"{RAW_DIR}/{DATASET}/ophys_experiment_data/{{dataset}}.nwb", dataset=SESSION_IDS)

rule download_data:
    output:
        nwb_files_ca = expand(f"{RAW_DIR}/{DATASET}/ophys_experiment_data/{{session_id}}.nwb", session_id=SESSION_IDS_NM)
    shell:
        f"""
        python data/scripts/allen_natural_movie_calcium/download_data.py --output_dir {RAW_DIR}/{DATASET}
        """

rule prepare_data:
    input:
        py_script = f"data/scripts/{DATASET}/prepare_data.py",
        nwb_files_ca = expand(f"{RAW_DIR}/{DATASET}/ophys_experiment_data/{{session_id}}.nwb", session_id=SESSION_IDS_NM)
    output:
        description = f"{PROCESSED_DIR}/{DATASET}/description.mpk"
    log:
        f".snakemake/logs/{DATASET}/prepare_data.log"
    shell:
        f"""
        pip install -r data/scripts/{DATASET}/requirements.txt
        mkdir -p {PROCESSED_DIR}/{DATASET}
        python data/scripts/{DATASET}/prepare_data.py --input_dir {RAW_DIR}/{DATASET} --output_dir {PROCESSED_DIR}/{DATASET}
        """

include: "../freeze.smk"